<!DOCTYPE html>
<html>
  <head>
    <title>Solar Tucson</title>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.14.0/css/ol.css" type="text/css">
	<link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <script src="http://openlayers.org/en/v3.14.0/build/ol.js"></script>
  </head>
  <body>
  <nav class="navbar navbar-default navbar-fixed-top">
	  <div class="container">
		<form class="form-inline" action="javascript: runSearch()">
			<div class="form-group">
				<label><h4>Solar Tucson</h4></label>
				<input type="text" class="form-control" id="address-search" placeholder="1401 E University Blvd, Tucson, AZ 85721">
			</div>
		</form>
	  </div>
	</nav>
    <div id="map" class="map"></div>
    <script>
	  // Load Aerial with Labels layer from bing maps
      var layers = [];
	  layers.push(new ol.layer.Tile({
		visible: true,
        preload: Infinity,
        source: new ol.source.BingMaps({
          key: 'AlmPp9qqz9ZI8noTd2a7HfRUPDbT8fNfhjedJ7FHzFLpqH3_7zDQWio4cA_qNryo',
          imagerySet: 'AerialWithLabels',
		  maxZoom: 19
        })
      }));
	  var overlay = new ol.layer.Tile({
	    visible: true,
        source: new ol.source.XYZ({
          url: 'http://cs.arizona.edu/people/woodti/tiles/{z}/{x}/{y}.png'
        })
      });
	  overlay.setOpacity(0.5);
	  layers.push(overlay);

	  // build map, center on Tucson
      var map = new ol.Map({
        layers: layers,
        target: 'map',
        loadTilesWhileInteracting: true,
        view: new ol.View({
          center: ol.proj.transform(
              [-110.9499, 32.23165], 'EPSG:4326', 'EPSG:3857'),
          resolution: 13
        })
      });
	  
	  // Called when search is run, uses geo location on address to get lat/lon
	  function runSearch() {
	    var xmlhttp = new XMLHttpRequest();
		var url = "http://nominatim.openstreetmap.org/search?format=json&q=" + document.getElementById('address-search').value.split(' ').join('+')
		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
				var myArr = JSON.parse(xmlhttp.responseText);
				moveToAddress(myArr);
			}
		};
		xmlhttp.open("GET", url, true);
		xmlhttp.send();
	  }
	  
	  // Move view to address
	  function moveToAddress(arr) {
		var duration = 2000;
        var start = +new Date();
        var pan = ol.animation.pan({
          duration: duration,
          source: /** @type {ol.Coordinate} */ (map.getView().getCenter()),
          start: start
        });
		var zoom = ol.animation.zoom({
		  duration: duration,
          resolution: map.getView().getResolution(),
          start: start
		});
		
        map.beforeRender(pan, zoom);
        map.getView().setCenter(ol.proj.fromLonLat([Number(arr[0].lon), Number(arr[0].lat)]));
		map.getView().setResolution(0.25);
	  }
    </script>
  </body>
</html>